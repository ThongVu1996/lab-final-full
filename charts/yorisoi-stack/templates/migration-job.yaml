apiVersion: batch/v1
kind: Job
metadata:
  # Thêm một hậu tố random nhỏ hoặc checksum để đảm bảo tên thay đổi nếu config thay đổi (Optional)
  # Nhưng quan trọng nhất là giữ nguyên format chuẩn của Helm
  name: {{ .Release.Name }}-migrate-{{ .Release.Revision }}
  annotations:
    # Chạy sau khi Install hoặc Upgrade xong
    "helm.sh/hook": post-install,post-upgrade
    
    # [QUAN TRỌNG 1] Policy xóa Job:
    # - before-hook-creation: Xóa job cũ cùng tên trước khi tạo job mới (Tránh lỗi trùng tên)
    # - hook-succeeded: Xóa ngay nếu chạy thành công (để sạch cluster)
    # - hook-failed: (Tùy chọn) Xóa nếu lỗi. Thường KHÔNG NÊN thêm cái này để còn debug log.
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  # [QUAN TRỌNG 2] Cơ chế tự hủy "triệt để" của Kubernetes
  # Tự động xóa sạch Pod và Job sau 100 giây kể từ khi chạy xong (Finished).
  # Giúp dọn dẹp rác ngay cả khi ArgoCD/Helm bị lag hoặc mất kết nối.
  ttlSecondsAfterFinished: 100

  # Giới hạn thời gian tối đa cho Job chạy. Nếu treo quá 5 phút thì tự hủy để tránh tốn tài nguyên.
  activeDeadlineSeconds: 300 

  # Số lần thử lại nếu lỗi kết nối DB
  backoffLimit: {{ .Values.migration.backoffLimit | default 3 }}

  template:
    metadata:
      name: {{ .Release.Name }}-migrate
    spec:
      restartPolicy: OnFailure
      containers:
        - name: migrate
          image: "{{ .Values.backend.image.repository }}:{{ .Values.backend.image.tag }}"
          imagePullPolicy: Always
          # Lệnh migrate chuẩn
          command: ["php", "artisan", "migrate", "--seed", "--force"]
          envFrom:
            - secretRef:
                name: {{ .Values.existingSecret }}
          env:
            # Đảm bảo lấy đúng DB_HOST mới nhất từ values.yaml
            - name: DB_HOST
              value: {{ .Values.backend.env.DB_HOST | quote }}
            # Thêm các biến môi trường khác nếu cần (DB_PORT, v.v.)
